# 网络层

路由是全局功能：规划当前主机到目标主机的路径，依靠路由表，控制平面

转发是局部功能：选择端口功能，对到来的数据报和具体的网络交换设备进行局部交换，数据平面

网络连接



流表是网络设备中的一个关键组件，尤其在现代网络架构如SDN（Software Defined Networking）中扮演着非常重要的角色。流表包含了一系列的流表项（flow entries），这些表项基于预定义的规则来处理经过网络设备的数据流。

## 流表

### 流表的功能和操作

流表的核心功能是根据数据包的头部信息（如源地址、目的地址、端口号等）进行数据包的查找、转发或丢弃等操作。具体的操作可以包括：

1. **匹配**：流表中的每条记录都包含一套匹配规则，例如IP地址、传输协议和端口号等。当数据包到达时，系统会根据这些参数在流表中查找匹配的条目。
   
2. **动作执行**：每条流表项还定义了一系列的动作，这些动作在匹配成功时执行。动作可能包括转发、修改、丢弃或将数据包发送到控制器等。

3. **统计**：流表项通常还会收集流量统计信息，如通过该条目的数据包数量和数据字节数，这对于网络管理和监控是非常有用的。

### 流表在不同技术中的应用

1. **传统路由器和交换机**：
   - 在传统的网络设备中，流表可能被实现为路由表或MAC地址表，用于决定如何处理进入的数据包。

2. **软件定义网络（SDN）**：
   - 在SDN架构中，流表的概念被扩展并广泛应用。例如，OpenFlow协议定义了一种标准化方式来管理设备的流表。SDN控制器可以动态修改流表，实现灵活的网络流量管理。

3. **网络功能虚拟化（NFV）**：
   - 在NFV环境中，流表可以帮助虚拟网络功能（VNF）更有效地处理经过虚拟设备的流量。

### 流表的管理和挑战

管理流表主要涉及流表的维护、优化和扩展。在大型或动态的网络环境中，流表的大小和复杂性可能导致资源消耗和性能瓶颈。挑战包括：

- **资源限制**：硬件设备中的流表空间是有限的，过多的流表项可能耗尽资源。
- **性能问题**：流表查找速度直接影响网络性能。高效的查找算法和硬件加速（如使用TCAM）是提高性能的关键。
- **动态更新**：在SDN环境中，流表需要频繁更新以响应网络策略变化，如何快速而准确地更新成为一个挑战。

总结来说，流表是现代网络设备中处理和转发数据包的基础设施，特别是在SDN和其他高度可编程的网络环境中，流表的管理和优化是保证网络高效运行的关键。

## IP分组

在网络通信中，理解IP分组（IP packet）和帧（frame）的概念及其结构非常重要。以下是这两个基本网络单位的举例说明：

### IP分组举例

IP分组是在互联网协议（如IPv4或IPv6）上构建的数据传输单位。一个典型的IPv4分组包含以下几个关键部分：

1. **头部（Header）**：通常20-60字节，包含诸如版本、头部长度、服务类型、总长度、标识、标志、片偏移、生存时间（TTL）、协议、头部校验和、源IP地址和目的IP地址等信息。
2. **数据（Payload）**：跟随头部的数据部分，可以包含来自各种应用程序的数据。

假设您正在使用HTTP协议浏览网页，浏览器会发送一个IP分组，其中包含HTTP请求信息。一个简化的例子如下：

- **源IP地址**：192.168.1.100
- **目的IP地址**：93.184.216.34（例如，一个网站的服务器IP）
- **生存时间（TTL）**：64
- **协议**：TCP（因为HTTP基于TCP）
- **数据**：包含HTTP请求的详细信息，如`GET / HTTP/1.1`

### 帧举例

帧是数据链路层的传输单位，包括从一个网络设备到另一个网络设备的物理地址信息。以太网帧是最常见的类型之一，其结构包括：

1. **目的MAC地址**：接收设备的硬件地址。
2. **源MAC地址**：发送设备的硬件地址。
3. **类型**：表明上层协议，通常是IP。
4. **数据**：这部分包括网络层的数据包，如IP分组。
5. **校验序列**（Frame Check Sequence, FCS）：用于错误检测。

一个具体的以太网帧示例可能包含以下内容：

- **目的MAC地址**：01:23:45:67:89:AB
- **源MAC地址**：98:76:54:32:10:FE
- **类型**：0x0800（表示载荷是IPv4数据包）
- **数据**：包含上面举例的整个IP分组。
- **校验序列**：一组用于错误检测的数据。

### 数据流向

当数据从一个应用程序传送到另一个地点时，它首先被封装成一个或多个IP分组（网络层），然后每个IP分组被封装到一个或多个帧中（数据链路层），通过物理网络进行传输。在接收端，这个过程被逆向执行，帧被解码以提取IP分组，然后IP分组被进一步处理以恢复原始的应用数据。

这些基本单位确保了网络通信的有效性和可靠性，是网络工程和数据通信领域的核心概念。

## ip数据报格式

![image-20240422091249893](/image-20240422091249893-1713775056206-24.png)

每一行4个字节，一共五行，固定头部20个字节；types of service是数据报类型，方便调度

第二行用于分片和重组，

TTL，time to leave；每过一个路由器，减一，抛弃后发回ICMP数据报到源主机

### Fragment分片和重组

![image-20240422092344158](/image-20240422092344158-1713775056207-25.png)

![image-20240422092940388](/image-20240422092940388-1713775056207-26.png)

MTU-最大传输单元=fragment的body大小，body部分承载IP数据报/分组（也有头部和body），输入输出大小不一致，不能直接切合分片会丢失头部信息

![image-20240422093414648](/image-20240422093414648-1713775056207-27.png)

三片同个ID，来自同一分组，切片是8个字节最小单位；用offset来解决先传后到的问题；目标主机来重组，如果一定时间收不到全部分组，就会抛弃

![image-20240422093853984](/image-20240422093853984-1713775056207-28.png)

fragflag来标识是否还有下一片；0--最后一片

### IP编址

▣IP地址：32位标示，对主机或者路由器的**接口**编址

路由器至少两个IP地址，

▣接口：主机/路由器和物理链路的连接处
	路由器通常拥有多个接口>=2
	主机也有可能有多个接口，插多个网卡，或者在一个网卡上虚拟多个ip地址
	IP地址和每一个接口关联
▣一个IP地址和一个接口相关联

在IP子网内部，一跳可达

### 子网-Subnets

Ip地址前缀相同，拥有相同的子网号

▣IP地址
子网部分（高位bts)
主机部分（地位bits)
▣什么是子网subnet)？一个子网内的节点（主机或者路由器)它们的**IP地址的高位部分**相同,这些节点构成的网络的一部分叫做子网无需路由器介入，子网内各主机可以在物理上相互直接到达，可以借助交换机，IP层片直接可达

在局域网内，一般通过交换机连接多个主机，多点连接；长途链路是点对点连接

### IP地址分类

全0和全1的主机号和网络号弃置

o Class A:126 networks 16 million hosts
o Class B:16382networks.64 K hosts
o Class C:2 million networks 254 host
o Class D:multicast
o Class E:reserved for future



![image-20240422101616299](/image-20240422101616299-1713775056207-29.png)

A、B、C为单播；D为单播；E为预留

a类第一个字节是网络号；路由是针对网络号转发，而不是单个地址，以网络为单位进行路由

#### 特殊IP地址

约定：
·子网部分：全为0--本网络
·主机部分：全为0--本主机
·主机部分：全为1-广播地址，这个网络的所有主机