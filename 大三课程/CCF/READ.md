https://www.datafountain.cn/competitions/1045

1. PDFæ–‡æœ¬æå–ï¼ˆBertæ¨¡å‹ï¼‰
2. å‘é‡æ•°æ®åº“
3. æ–‡æœ¬å‘é‡åŒ–-å·²ç»æœ‰äº†æ¨¡å‹bge-large-zh-v1.5
4. çŸ¥è¯†åº“æ„å»º

é€šè¿‡ä½¿ç”¨RAGæ£€ç´¢å¢å¼ºç”ŸæˆæŠ€æœ¯å°†ç§åŸŸæ•°æ®ä½œä¸ºå¤§æ¨¡å‹çš„å¤–æ¥çŸ¥è¯†åº“ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³å¤§æ¨¡å‹çŸ¥è¯†å¹»è§‰çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯å½“å‰å¤§æ¨¡å‹åº”ç”¨è½åœ°çš„ä¸»è¦æ–¹å¼ä¹‹ä¸€ã€‚è€ŒçŸ¥è¯†åº“çš„æ­å»ºä¸ä¿¡æ¯æ£€ç´¢ç¯èŠ‚ç›´æ¥å½±å“åˆ°æœ€ç»ˆæ¨¡å‹çš„æ•ˆæœï¼Œæ˜¯è¿™ä¸€æŠ€æœ¯å®è·µä¸­çš„å…³é”®ç¯èŠ‚ã€‚å¦‚ä½•è®¾è®¡æ–‡æ¡£è§£æã€çŸ¥è¯†åº“ç”Ÿæˆã€æ–‡æœ¬å¬å›çš„ç­–ç•¥ï¼Œä»¥æ›´å‡†ç¡®åœ°å‘å¤§æ¨¡å‹æä¾›ç”¨æˆ·é—®é¢˜å¯¹åº”çš„ç­”æ¡ˆä¿¡æ¯ï¼Œå…·æœ‰é‡è¦çš„ç ”ç©¶ä»·å€¼å’Œå®é™…æ„ä¹‰ã€‚

**â€¢ èµ›é¢˜ä»»åŠ¡**

æœ¬èµ›é¢˜è¦æ±‚é€‰æ‰‹ä½¿ç”¨è¿è¥å•†ç›¸å…³çš„æ–‡æ¡£æ„å»ºçŸ¥è¯†åº“ï¼Œæ ¹æ®ç”¨æˆ·é—®é¢˜æ£€ç´¢çŸ¥è¯†åº“å¹¶è¿”å›ç­”æ¡ˆæ‰€åœ¨çš„æ–‡æœ¬å—ã€‚

æœ¬èµ›é¢˜è¦æ±‚é€‰æ‰‹ä½¿ç”¨è¿è¥å•†ç›¸å…³çš„æ–‡æ¡£æ„å»ºçŸ¥è¯†åº“ï¼Œæ ¹æ®ç”¨æˆ·é—®é¢˜æ£€ç´¢çŸ¥è¯†åº“å¹¶è¿”å›ç­”æ¡ˆæ‰€åœ¨çš„æ–‡æœ¬å—ã€‚é€‰æ‰‹éœ€è¦å®Œæˆçš„ä»»åŠ¡å¯èƒ½åŒ…æ‹¬ä½†ä¸é™äºï¼š
ï¼ˆ1ï¼‰æ–‡æ¡£è§£æï¼šå°†è¿è¥å•†ç›¸å…³çš„PDFæ–‡æ¡£è§£æä¸ºæ–‡æœ¬æ•°æ®ã€‚
ï¼ˆ2ï¼‰çŸ¥è¯†åº“ç”Ÿæˆï¼šå®Œæˆæ–‡æœ¬åˆ†å—å’Œå‘é‡åŒ–å¤„ç†ï¼Œå¹¶å­˜å‚¨å…¥å‘é‡æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥å°è¯•æ„å»ºçŸ¥è¯†å›¾è°±ã€‚æœ¬èµ›é¢˜é™å®šé€‰æ‰‹åº”ä½¿ç”¨bge-large-zh-v1.5æ¨¡å‹è¿›è¡Œæ–‡æœ¬å‘é‡åŒ–ã€‚
ï¼ˆ3ï¼‰æ–‡æœ¬å¬å›ï¼šåŸºäºå‘é‡æ£€ç´¢ã€å…³é”®å­—æ£€ç´¢ç­‰æ–¹æ³•è®¾è®¡å¬å›ç­–ç•¥ï¼Œè¿”å›é—®é¢˜ç­”æ¡ˆæ‰€åœ¨çš„æ–‡æœ¬å—ã€‚

**èµ›é¢˜ä»»åŠ¡åŒºåˆ†Aã€Bæ¦œ**ï¼š
ï¼ˆ1ï¼‰Aæ¦œæœŸé—´æä¾›120ç¯‡æ–‡æ¡£å’Œ100ä¸ªè¯„æµ‹é—®é¢˜ï¼Œæ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆéƒ½å¯ä»¥åœ¨æ–‡æ¡£åŸæ–‡ä¸­æ‰¾åˆ°ã€‚é€‰æ‰‹å¯æ ¹æ®Aæ¦œè¯„æµ‹ç»“æœè®¾è®¡å¹¶æŒç»­æ”¹è¿›æ–¹æ¡ˆåŠä»£ç ï¼Œæ’è¡Œæ¦œå°†è®°å½•é€‰æ‰‹å†æ¬¡æäº¤ä¸­çš„æœ€é«˜æˆç»©ã€‚
ï¼ˆ2ï¼‰Bæ¦œæœŸé—´æä¾›70ä»½æ–°æ–‡æ¡£å’Œ80ä¸ªæ–°è¯„æµ‹é—®é¢˜ï¼Œé€‰æ‰‹éœ€ä½¿ç”¨Aæ¦œæœŸé—´è®¾è®¡çš„æ–¹æ¡ˆåŠä»£ç ï¼Œå‘çŸ¥è¯†åº“è¡¥å……æ–°æ–‡æ¡£å†…å®¹åè¿›è¡Œå¬å›ã€‚Bæ¦œé—®é¢˜ä¸­çº¦70%ä¸æ–°æ–‡æ¡£æœ‰å…³ï¼Œå¦å¤–30%å‡ºè‡ªAæ¦œæœŸé—´å·²æä¾›çš„æ–‡æ¡£ï¼Œæ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆéƒ½å¯ä»¥åœ¨æ–‡æ¡£åŸæ–‡ä¸­æ‰¾åˆ°ã€‚é€‰æ‰‹åœ¨Bæ¦œæœŸé—´åªå¯ä»¥æäº¤ä¸‰æ¬¡è¯„æµ‹,å¹¶ä¸”ä»…ä»¥æœ€åä¸€æ¬¡æäº¤çš„ç»“æœä¸ºå‡†ã€‚

æœ¬èµ›é¢˜ä½¿ç”¨çš„è¿è¥å•†ç›¸å…³æ–‡æ¡£åŒ…æ‹¬ä¸‰ç±»ï¼š
ï¼ˆ1ï¼‰æ–°é—»ç¨¿ä»¶150ç¯‡ï¼Œéƒ¨åˆ†æ–‡æ¡£ç»è¿‡æ”¹å†™æˆ–æ‰©å†™ï¼Œå› æ­¤å†…å®¹å¯èƒ½ä¸ç°å®æƒ…å†µä¸ç¬¦ï¼Œå¯èƒ½ä¸å…·æœ‰ç°å®æ„ä¹‰ï¼Œä»…å…è®¸åœ¨æœ¬æ¬¡æ¯”èµ›ä¸­ä½¿ç”¨ã€‚
ï¼ˆ2ï¼‰å…¬å¼€æŠ¥å‘Š25ç¯‡ï¼ŒåŒ…æ‹¬å¹´åº¦åŠåŠå¹´åº¦æŠ¥å‘Šæ‘˜è¦ã€å­£åº¦æŠ¥å‘Šã€è‚¡ä¸œå¤§ä¼šä¼šè®®èµ„æ–™ç­‰ã€‚
ï¼ˆ3ï¼‰é€šä¿¡è¡Œä¸šæƒå¨ç ”ç©¶æŠ¥å‘ŠåŠç™½çš®ä¹¦15ç¯‡ï¼ˆæ¥æºï¼šä¸­å›½ä¿¡æ¯é€šä¿¡ç ”ç©¶é™¢ï¼‰ã€‚
è¯„æµ‹é—®é¢˜çš„ç­”æ¡ˆç”±äººå·¥æ ‡æ³¨å¹¶è¿›è¡Œå¤æ ¸ï¼Œå…·ä½“è§è¯„æµ‹æ ‡å‡†ã€‚

## æäº¤è¦æ±‚

é€‰æ‰‹éœ€æŒ‰submit_example.csvçš„æ ¼å¼æäº¤UTF-8ç¼–ç çš„è¯„æµ‹æ–‡ä»¶ã€‚æ¯è¡ŒåŒ…æ‹¬å››åˆ—å†…å®¹ï¼Œç¬¬1åˆ—ques_idä¸ºé—®é¢˜ç¼–å·ï¼Œç¬¬2åˆ—questionä¸ºé—®é¢˜åŸæ–‡ï¼Œç¬¬3åˆ—answerä¸ºé€‰æ‰‹è¿”å›çš„é—®é¢˜ç­”æ¡ˆæ‰€åœ¨æ–‡æœ¬å—ï¼Œç¬¬4åˆ—embeddingä¸ºå°†ç¬¬3åˆ—æ–‡æœ¬å—ä½¿ç”¨bge-large-zh-v1.5å‘é‡æ¨¡å‹æ˜ å°„å¾—åˆ°çš„å‘é‡è¡¨ç¤ºã€‚é€‰æ‰‹æäº¤çš„ç­”æ¡ˆæ–‡ä»¶æ ¼å¼åº”ä¸submit_example.csvä¸¥æ ¼ä¸€è‡´ã€‚
å‘é‡æ¨¡å‹ä¸‹è½½åœ°å€ï¼š
https://www.modelscope.cn/models/AI-ModelScope/bge-large-zh-v1.5
Bæ¦œTOP5é˜Ÿä¼å°†è¿›å…¥å¤ç°å®¡æ ¸é˜¶æ®µï¼Œéœ€å°†æ–¹æ¡ˆæ–‡æ¡£ã€æºä»£ç ç­‰å‹ç¼©æ‰“åŒ…åæäº¤ï¼Œè¦æ±‚æºä»£ç èƒ½å¤ç°Bæ¦œæ¦œå•ç»“æœã€‚å¤ç°å®¡æ ¸é€šè¿‡åçš„é˜Ÿä¼å°†è¿›å…¥å†³èµ›çº¿ä¸‹ç­”è¾©è¯„å®¡ã€‚

## è¯„æµ‹æ ‡å‡†

â€¢ **é—®é¢˜è¯„åˆ†**
å¯¹äºä»»æ„é—®é¢˜ï¼Œé‡‡ç”¨å¦‚ä¸‹å…¬å¼è¯„åˆ†ï¼š

**score ğ‘–=[\*i\*=[ weight ğ‘–ğ‘˜ğ‘¤Ã—\*i\**k\**w\*Ã— score ğ‘–ğ‘˜ğ‘¤+(1âˆ’\*i\**k\**w\*+(1âˆ’ weight ğ‘–ğ‘˜ğ‘¤)Ã—\*i\**k\**w\*)Ã— score ğ‘–ğ‘’ğ‘ ]Ã—ğ‘ğ‘–\*i\**e\**s\*]Ã—\*p\**i\***

**scoreikw**: å…³é”®è¯è¯„åˆ†ã€‚å‡ºé¢˜æ–¹ä¸ºæ¯é¢˜æ ‡æ³¨äº†è‹¥å¹²ç­”æ¡ˆå…³é”®è¯ï¼Œé€‰æ‰‹æäº¤æ–‡ä»¶çš„answeråˆ—ä¸­å‡†ç¡®åŒ…å«æ‰€æœ‰å…³é”®è¯å¾—1åˆ†ï¼ŒåŒ…å«éƒ¨åˆ†å…³é”®è¯åˆ™æŒ‰æ¯”ä¾‹å¾—åˆ†ã€‚
**scoreies** ï¼šå‘é‡ç›¸ä¼¼åº¦è¯„åˆ†ã€‚å‡ºé¢˜æ–¹ä¸ºæ¯é¢˜æ ‡æ³¨äº†ç­”æ¡ˆæ‰€åœ¨æ–‡æœ¬å—ï¼Œæ ¹æ®é€‰æ‰‹æäº¤æ–‡ä»¶ä¸­embeddingåˆ—ä¸æ ‡æ³¨æ–‡æœ¬å—å‘é‡è¡¨ç¤ºçš„ä½™å¼¦ç›¸ä¼¼åº¦æ‰“åˆ†ï¼Œå®Œå…¨ä¸€è‡´å¾—1åˆ†ã€‚
**weightikw** ï¼šå…³é”®è¯è¯„åˆ†å æ€»è¯„åˆ†çš„æƒé‡ã€‚é€šå¸¸ä¸º0.1è‡³0.9ä¹‹é—´çš„æƒé‡ï¼Œè¡¨æ ¼æŸ¥æ•°é—®é¢˜çš„å…³é”®è¯å¾—åˆ†æƒé‡ä¸º1ã€‚
**pi**ï¼šé•¿åº¦æƒ©ç½šé¡¹ã€‚æ ¹æ®é€‰æ‰‹ answer çš„é•¿åº¦ ğ‘™ğ‘’ğ‘›ğ‘–ğ‘ ğ‘¢ğ‘*l**e**n**i**s**u**b*â€‹ ä¸æ ‡æ³¨æ–‡æœ¬å—é•¿åº¦ ğ‘™ğ‘’ğ‘›ğ‘–ğ‘ ğ‘¡ğ‘‘*l**e**n**i**s**t**d*â€‹ ç¡®å®š, ğ‘™ğ‘’ğ‘›ğ‘–sub â‰¤1.5ğ‘™ğ‘’ğ‘›ğ‘–std *l**e**n**i*sub â€‹â‰¤1.5*l**e**n**i*std â€‹ æ—¶è¯¥é¡¹ä¸º 1;1.51;1.5 len ğ‘–std <ğ‘™ğ‘’ğ‘›ğ‘–sub â‰¤2.5ğ‘™ğ‘’ğ‘›ğ‘–std *i*std â€‹<*l**e**n**i*sub â€‹â‰¤2.5*l**e**n**i*std â€‹ æ—¶è¯¥é¡¹ä¸º 0.9;0.9; ğ‘™ğ‘’ğ‘›ğ‘–sub >2.5ğ‘™ğ‘’ğ‘›ğ‘–std *l**e**n**i*sub â€‹>2.5*l**e**n**i*std â€‹ æ—¶è¯¥é¡¹ä¸º 0.75 ã€‚

â€¢ **æ¦œå•æ€»åˆ†**
ABæ¦œåˆ†æ•°è®¡ç®—å…¬å¼ä¸ºï¼š

**totalscore =âˆ‘ğ‘–ğ‘“ğ‘–Ã—=âˆ‘\*i\*\*f\**i\*Ã— score ğ‘–\*i\***

**fi**ï¼šéš¾åº¦ç³»æ•°ã€‚é€šå¸¸ä¸º1ï¼Œå°‘éƒ¨åˆ†é—®é¢˜çš„éš¾åº¦ç³»æ•°ä¸º2ï¼Œå®ƒä»¬å…·æœ‰ä»¥ä¸‹ç‰¹å¾ä¹‹ä¸€ï¼šï¼ˆ1ï¼‰é—®é¢˜ç­”æ¡ˆå­˜åœ¨äºæ–‡æ¡£è¡¨æ ¼ä¸­ï¼›ï¼ˆ2ï¼‰é—®é¢˜ç­”æ¡ˆæ¶‰åŠæ–‡æ¡£å¤šä¸ªæ®µè½æˆ–è€…å¤šä¸ªæ–‡æ¡£ï¼Œéœ€è¦é€‰æ‰‹å°†å¤šä¸ªæ–‡æœ¬å—åˆå¹¶åè¿”å›ã€‚

## å…¬å¹³ç«æŠ€

1.å‚èµ›å›¢é˜Ÿéœ€å…±åŒç»´æŠ¤ç«èµ›ç¯å¢ƒçš„å…¬å¹³å…¬æ­£ï¼Œç¦æ­¢åœ¨æŒ‡å®šè€ƒæ ¸æŠ€æœ¯èƒ½åŠ›çš„èŒƒå›´å¤–ï¼Œåˆ©ç”¨è§„åˆ™æ¼æ´æˆ–æŠ€æœ¯æ¼æ´ç­‰ä¸è‰¯é€”å¾„æé«˜æˆç»©ä¸æ’åï¼Œç¦æ­¢åœ¨æ¯”èµ›ä¸­æŠ„è¢­ä»–äººä½œå“ã€äº¤æ¢ç­”æ¡ˆã€ä½¿ç”¨å¤šä¸ªå°å·ï¼Œä¸€ç»å‘ç°å°†å–æ¶ˆæ¯”èµ›æˆç»©å¹¶ä¸¥è‚ƒå¤„ç†ã€‚
2.DataFountainåŸºäºè‡ªåŠ¨åŒ–åä½œå¼Šç³»ç»Ÿã€ç»“åˆäººå·¥å®¡æ ¸ï¼Œèµ›ä¸­åŠ¨æ€åè¿è§„ã€åä½œå¼Šï¼Œè‹¥æ”¶åˆ°å›¢é˜Ÿå°ç¦é€šçŸ¥ï¼Œå¯åœ¨æŒ‡å®šé¡µé¢ç”³è¯‰ã€‚



è¯¥ä»£ç æ˜¯ä¸€ä¸ªå¤„ç†PDFæ–‡æ¡£ã€æå–å’Œè¿‡æ»¤æ–‡æœ¬ã€å°†æ–‡æœ¬åˆ†å—ã€å‘é‡åŒ–æ–‡æœ¬ï¼Œå¹¶æ ¹æ®æŸ¥è¯¢æ‰§è¡Œæ£€ç´¢å’Œé‡æ–°æ’åºçš„Pythonè„šæœ¬ã€‚ä»¥ä¸‹æ˜¯ä»£ç å„ä¸ªéƒ¨åˆ†çš„ä½œç”¨åŠå…¶æ¶‰åŠçš„çŸ¥è¯†é¢†åŸŸçš„è§£æï¼š

### 1. å¯¼å…¥åº“
ä»£ç å¯¼å…¥äº†ç”¨äºæ–‡æ¡£å¤„ç†ã€æ–‡æœ¬åˆ†å‰²ã€åµŒå…¥ã€æ£€ç´¢å’Œå…¶ä»–å®ç”¨ç¨‹åºçš„å„ç§åº“ã€‚
```python
from langchain_community.document_loaders import PyPDFDirectoryLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter, CharacterTextSplitter, TokenTextSplitter
from langchain_community.embeddings.huggingface import HuggingFaceEmbeddings
from langchain_community.retrievers.bm25 import BM25Retriever
from langchain.retrievers import EnsembleRetriever
from langchain_community.vectorstores import Chroma, FAISS
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough, RunnableParallel
from sentence_transformers import SentenceTransformer
from tqdm import tqdm
import pandas as pd
import numpy as np
import torch
import os
import gc
import re
from IPython.display import display
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šPythonã€è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ã€æ–‡æ¡£å¤„ç†ã€æœºå™¨å­¦ä¹ 

### 2. è®¾ç½®å¸¸é‡
å®šä¹‰ç›®å½•ã€æ¨¡å‹å’Œæ–‡ä»¶çš„å¸¸é‡ã€‚
```python
DOCS_DIR = './A/A_document'
EMB_MODEL = './bge-large-zh-v1.5'
RERANK_MODEL = "./bge-reranker-large"
PERSIST_DIR = './vectordb'
QUERY_DIR = './A/A_question.csv'
SUB_DIR = './submit_example.csv'
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ–‡ä»¶å¤„ç†ã€é…ç½®ç®¡ç†

### 3. åŠ è½½å’Œæ˜¾ç¤ºæ•°æ®
ä»CSVæ–‡ä»¶åŠ è½½æŸ¥è¯¢å’Œæäº¤æ•°æ®ï¼Œå¹¶æ˜¾ç¤ºå‰å‡ è¡Œã€‚
```python
query = pd.read_csv(QUERY_DIR)
sub = pd.read_csv("./submit_example.csv")
display(query.head(3))
display(sub.head(3))
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ•°æ®å¤„ç†ã€Pandas

### 4. PDFæ–‡æ¡£è§£æå’Œåˆ‡åˆ†
åŠ è½½å¹¶å°†PDFæ–‡æ¡£åˆ†å‰²æˆé¡µé¢ã€‚
```python
loader = PyPDFDirectoryLoader(DOCS_DIR)
pages = loader.load_and_split()
pdf_list = os.listdir(DOCS_DIR)
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ–‡æ¡£å¤„ç†ã€PDFå¤„ç†

### 5. æ–‡æœ¬è¿‡æ»¤
å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡åˆ é™¤ä¸éœ€è¦çš„æ¨¡å¼å’Œå­—ç¬¦æ¥è¿‡æ»¤æ–‡æœ¬ã€‚
```python
def filter_text(text):
    text = text.replace('\n','').replace(' ','')
    head_pattern = 'æœ¬æ–‡æ¡£ä¸º2024CCFBDCIæ¯”èµ›ç”¨è¯­æ–™çš„ä¸€éƒ¨åˆ†ã€‚[^\s]+ä»…å…è®¸åœ¨æœ¬æ¬¡æ¯”èµ›ä¸­ä½¿ç”¨ã€‚'
    pattern1 = r"å‘å¸ƒæ—¶é—´ï¼š[^\s]+å‘å¸ƒäººï¼šæ–°é—»å®£ä¼ ä¸­å¿ƒ"
    pattern2 = r"å‘å¸ƒæ—¶é—´ï¼š[^\s]+å‘å¸ƒäººï¼šæ–°é—»å‘å¸ƒäºº"
    pattern3 =  r'å‘å¸ƒæ—¶é—´ï¼š\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥'
    news_pattern = head_pattern+'|'+pattern1+'|'+pattern2+'|'+pattern3
    text = re.sub(news_pattern,'',text)
    report_pattern1 = 'ç¬¬ä¸€èŠ‚é‡è¦æç¤º[^\s]+æœ¬æ¬¡åˆ©æ¶¦åˆ†é…æ–¹æ¡ˆå°šéœ€æäº¤æœ¬å…¬å¸è‚¡ä¸œå¤§ä¼šå®¡è®®ã€‚'
    report_pattern12 = 'ä¸€é‡è¦æç¤º[^\s]+è‚¡ä¸œå¤§ä¼šå®¡è®®ã€‚'
    report_pattern13 = 'ä¸€ã€é‡è¦æç¤º[^\s]+å­£åº¦æŠ¥å‘Šæœªç»å®¡è®¡ã€‚'
    report_pattern2 = 'æœ¬å…¬å¸è‘£äº‹ä¼šåŠå…¨ä½“è‘£äº‹ä¿è¯æœ¬å…¬å‘Šå†…å®¹ä¸å­˜åœ¨ä»»ä½•è™šå‡è®°è½½ã€[^\s]+å­£åº¦è´¢åŠ¡æŠ¥è¡¨æ˜¯å¦ç»å®¡è®¡â–¡æ˜¯âˆšå¦'
    report_pattern3 = 'ä¸­å›½è”åˆç½‘ç»œé€šä¿¡è‚¡ä»½æœ‰é™å…¬å¸ï¼ˆç®€ç§°â€œå…¬å¸â€ï¼‰è‘£äº‹ä¼šå®¡è®¡å§”å‘˜ä¼šæ ¹æ®ç›¸å…³æ³•å¾‹æ³•è§„ã€[^\s]+æ±‡æŠ¥å¦‚ä¸‹ï¼š'
    report_pattern = report_pattern1+'|'+report_pattern12+'|'+report_pattern13+'|'+report_pattern2+'|'+report_pattern3
    text = re.sub( report_pattern,'',text)
    return text
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ–‡æœ¬å¤„ç†ã€æ­£åˆ™è¡¨è¾¾å¼

### 6. åº”ç”¨æ–‡æœ¬è¿‡æ»¤
åº”ç”¨æ–‡æœ¬è¿‡æ»¤å‡½æ•°åˆ°åŠ è½½çš„PDFæ–‡æœ¬å¹¶å°†ç»“æœä¿å­˜åˆ°æ–‡ä»¶ã€‚
```python
for pdf_id in pdf_text.keys():
    pdf_text[pdf_id] = filter_text(pdf_text[pdf_id])
with open('AZ.txt','w',encoding = 'utf-8') as file:
    pdf_all = ''.join(list(pdf_text.values())).encode('utf-8', 'replace').decode('utf-8')
    file.write( pdf_all)
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ–‡ä»¶å¤„ç†ã€æ–‡æœ¬å¤„ç†

### 7. åŠ è½½å’Œåˆ†å‰²æ–‡æœ¬
åŠ è½½è¿‡æ»¤åçš„æ–‡æœ¬å¹¶å°†å…¶åˆ†å‰²æˆå—ã€‚
```python
from langchain_community.document_loaders import TextLoader
loader = TextLoader("AZ.txt",encoding="utf-8")
documents = loader.load()
text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=245,
        chunk_overlap=128,
        separators = ["ã€‚", "ï¼", "ï¼Ÿ"],
        keep_separator='end',
    )
docs = text_splitter.split_documents(documents)
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ–‡æœ¬åˆ†å‰²ã€NLP

### 8. å‘é‡åŒ–æ–‡æœ¬
ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹åµŒå…¥æ–‡æœ¬å—å¹¶ä¿å­˜åµŒå…¥ã€‚
```python
embeddings = HuggingFaceEmbeddings(model_name=EMB_MODEL, show_progress=True)
vectordb = FAISS.from_documents(
    documents=docs,
    embedding=embeddings,
)
vectordb.save_local(PERSIST_DIR)
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šåµŒå…¥ã€å‘é‡æ•°æ®åº“ã€æœºå™¨å­¦ä¹ 

### 9. è®¾ç½®æ£€ç´¢å™¨
è®¾ç½®å¯†é›†å’ŒBM25æ£€ç´¢å™¨å¹¶å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªé›†æˆæ£€ç´¢å™¨ã€‚
```python
import jieba
dense_retriever = vectordb.as_retriever(search_kwargs={"k": 5})
bm25_retriever = BM25Retriever.from_documents(
    docs,
    k=5,
    bm25_params={"k1": 1.5, "b": 0.75},
    preprocess_func=jieba.lcut
)
ensemble_retriever = EnsembleRetriever(retrievers=[bm25_retriever, dense_retriever], weights=[0.4, 0.6])
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šä¿¡æ¯æ£€ç´¢ã€NLP

### 10. æ–‡æœ¬å¬å›å’Œé‡æ’
å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ ¹æ®æŸ¥è¯¢æ£€ç´¢å’Œé‡æ–°æ’åºæ–‡æœ¬ã€‚
```python
from langchain.retrievers import ContextualCompressionRetriever
from langchain.retrievers.document_compressors import CrossEncoderReranker
from langchain_community.cross_encoders import HuggingFaceCrossEncoder

def rerank(questions, retriever, top_n=1, cut_len=384):
    rerank_model = HuggingFaceCrossEncoder(model_name=RERANK_MODEL)
    compressor = CrossEncoderReranker(model=rerank_model, top_n=top_n)
    compression_retriever = ContextualCompressionRetriever(
        base_compressor=compressor, base_retriever=retriever
    )
    rerank_answers = []
    for question in tqdm(questions):
        relevant_docs = compression_retriever.invoke(question)
        answer=''
        for rd in relevant_docs:
            answer += rd.page_content
        rerank_answers.append(answer[:245])
    return rerank_answers

questions = list(query['question'].values)
rerank_answers = rerank(questions, ensemble_retriever)
print(rerank_answers[0])
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šä¿¡æ¯æ£€ç´¢ã€NLPã€æœºå™¨å­¦ä¹ 

### 11. åµŒå…¥ç­”æ¡ˆ
ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹åµŒå…¥é‡æ–°æ’åºçš„ç­”æ¡ˆã€‚
```python
def emb(answers, emb_batch_size = 4):
    model = SentenceTransformer(EMB_MODEL, trust_remote_code=True)
    all_sentence_embeddings = []
    for i in tqdm(range(0, len(answers), emb_batch_size), desc="embedding sentences"):
        batch_sentences = answers[i:i+emb_batch_size]
        sentence_embeddings = model.encode(batch_sentences, normalize_embeddings=True)
        all_sentence_embeddings.append(sentence_embeddings)
    all_sentence_embeddings = np.concatenate(all_sentence_embeddings, axis=0)
    print('emb_model max_seq_length: ', model.max_seq_length)
    print('emb_model embeddings_shape: ', all_sentence_embeddings.shape[-1])
    del model
    gc.collect()
    torch.cuda.empty_cache()
    return all_sentence_embeddings

all_sentence_embeddings = emb(rerank_answers)
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šåµŒå…¥ã€æœºå™¨å­¦ä¹ 

### 12. ä¿å­˜ç»“æœ
å°†é‡æ–°æ’åºçš„ç­”æ¡ˆåŠå…¶åµŒå…¥ä¿å­˜åˆ°CSVæ–‡ä»¶ã€‚
```python
sub['answer'] = rerank_answers
sub['embedding']= [','.join([str(a) for a in all_sentence_embeddings[i]]) for i in range(len(all_sentence_embeddings))]
sub.to_csv('submit.csv', index=None)
sub.head()
```
**çŸ¥è¯†é¢†åŸŸ**ï¼šæ•°æ®å¤„ç†ã€Pandasã€æ–‡ä»¶å¤„ç†